<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Direct Browser Test</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .log { background: #f8f9fa; padding: 10px; margin: 10px 0; border-radius: 3px; font-family: monospace; white-space: pre-wrap; }
        .success { background-color: #d4edda; }
        .error { background-color: #f8d7da; }
        button { padding: 10px 20px; margin: 5px; }
    </style>
</head>
<body>
    <h1>üîß Direct Browser Authentication Test</h1>
    <p>This will test authentication directly in your browser with detailed error logging.</p>
    
    <button onclick="testLogin()">Test Login (business@scn.com)</button>
    <button onclick="testWithDifferentMethod()">Test with XMLHttpRequest</button>
    <button onclick="testCORS()">Test CORS Preflight</button>
    
    <div id="results"></div>

    <script>
        function log(message, isError = false) {
            const div = document.createElement('div');
            div.className = `log ${isError ? 'error' : 'success'}`;
            div.textContent = `[${new Date().toISOString()}] ${message}`;
            document.getElementById('results').appendChild(div);
        }

        async function testLogin() {
            log('üîç Starting fetch() test...');
            
            const url = 'https://scn-esg-backend.onrender.com/api/v1/users/auth/login/';
            const payload = {
                email: 'business@scn.com',
                password: 'business123'
            };
            
            log(`URL: ${url}`);
            log(`Payload: ${JSON.stringify(payload)}`);
            log(`Origin: ${window.location.origin}`);
            log(`User Agent: ${navigator.userAgent}`);
            
            try {
                log('Sending fetch request...');
                
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(payload),
                    mode: 'cors',
                    credentials: 'omit'
                });
                
                log(`Response received!`);
                log(`Status: ${response.status} ${response.statusText}`);
                log(`Response URL: ${response.url}`);
                log(`Response Type: ${response.type}`);
                log(`Headers: ${JSON.stringify(Object.fromEntries(response.headers))}`);
                
                if (response.ok) {
                    const data = await response.json();
                    log(`‚úÖ SUCCESS! Data: ${JSON.stringify(data, null, 2)}`);
                } else {
                    const errorText = await response.text();
                    log(`‚ùå HTTP Error: ${errorText}`, true);
                }
                
            } catch (error) {
                log(`‚ùå FETCH ERROR: ${error.name}: ${error.message}`, true);
                log(`Error stack: ${error.stack}`, true);
                
                // Check specific error types
                if (error.name === 'TypeError' && error.message.includes('fetch')) {
                    log('This is likely a CORS or network connectivity issue', true);
                }
            }
        }

        async function testWithDifferentMethod() {
            log('üîç Starting XMLHttpRequest test...');
            
            return new Promise((resolve) => {
                const xhr = new XMLHttpRequest();
                const url = 'https://scn-esg-backend.onrender.com/api/v1/users/auth/login/';
                
                xhr.open('POST', url, true);
                xhr.setRequestHeader('Content-Type', 'application/json');
                xhr.setRequestHeader('Accept', 'application/json');
                
                xhr.onreadystatechange = function() {
                    log(`XHR State: ${xhr.readyState}, Status: ${xhr.status}`);
                    
                    if (xhr.readyState === 4) {
                        if (xhr.status === 200) {
                            log(`‚úÖ XHR SUCCESS! Response: ${xhr.responseText}`);
                        } else {
                            log(`‚ùå XHR Error: Status ${xhr.status}, Response: ${xhr.responseText}`, true);
                        }
                        resolve();
                    }
                };
                
                xhr.onerror = function() {
                    log(`‚ùå XHR Network Error`, true);
                    resolve();
                };
                
                xhr.ontimeout = function() {
                    log(`‚ùå XHR Timeout`, true);
                    resolve();
                };
                
                const payload = JSON.stringify({
                    email: 'business@scn.com',
                    password: 'business123'
                });
                
                log(`Sending XHR request: ${payload}`);
                xhr.send(payload);
            });
        }

        async function testCORS() {
            log('üîç Testing CORS preflight...');
            
            try {
                const response = await fetch('https://scn-esg-backend.onrender.com/api/v1/users/auth/login/', {
                    method: 'OPTIONS',
                    headers: {
                        'Origin': window.location.origin,
                        'Access-Control-Request-Method': 'POST',
                        'Access-Control-Request-Headers': 'Content-Type'
                    }
                });
                
                log(`CORS Preflight Status: ${response.status}`);
                log(`CORS Headers: ${JSON.stringify(Object.fromEntries(response.headers))}`);
                
                if (response.ok) {
                    log('‚úÖ CORS preflight successful');
                } else {
                    log('‚ùå CORS preflight failed', true);
                }
                
            } catch (error) {
                log(`‚ùå CORS test error: ${error.message}`, true);
            }
        }

        // Auto-run basic test on load
        window.onload = function() {
            log('üöÄ Browser test tool loaded');
            log(`Location: ${window.location.href}`);
            log(`Protocol: ${window.location.protocol}`);
            log(`Secure Context: ${window.isSecureContext}`);
        };
    </script>
</body>
</html>
